// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// User model for authentication and authorization
model User {
  id        String     @id @default(cuid())
  email     String     @unique
  password  String
  name      String
  role      UserRole   @default(STAFF)
  active    Boolean    @default(true)
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt

  // Relations
  warehouseAccess WarehouseAccess[]
  activities      Activity[]
  stockTransfers  StockTransfer[]

  @@map("users")
}

enum UserRole {
  ADMIN
  MANAGER
  STAFF
  VIEWER
}

// Warehouse model
model Warehouse {
  id        String   @id @default(cuid())
  name      String   @unique
  location  String
  capacity  Int      // Total storage capacity
  active    Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  stocks    Stock[]
  accesses  WarehouseAccess[]
  transfers StockTransfer[]

  @@map("warehouses")
}

// Warehouse access control
model WarehouseAccess {
  id          String   @id @default(cuid())
  userId      String
  warehouseId String
  role        String   // Can have different roles per warehouse
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  warehouse Warehouse @relation(fields: [warehouseId], references: [id], onDelete: Cascade)

  @@unique([userId, warehouseId])
  @@map("warehouse_accesses")
}

// Product model
model Product {
  id          String   @id @default(cuid())
  sku         String   @unique
  name        String
  description String?
  category    String
  unitPrice   Float
  unit        String   @default("pcs") // pieces, kg, liter, etc.
  active      Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  stocks       Stock[]
  movements    StockMovement[]
  suppliers    ProductSupplier[]
  transfers    StockTransfer[]

  @@index([category])
  @@map("products")
}

// Supplier model
model Supplier {
  id          String   @id @default(cuid())
  name        String   @unique
  email       String?
  phone       String?
  address     String?
  city        String?
  country     String?
  active      Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  products ProductSupplier[]
  orders   PurchaseOrder[]

  @@map("suppliers")
}

// Product-Supplier relationship (many-to-many)
model ProductSupplier {
  id         String   @id @default(cuid())
  productId  String
  supplierId String
  supplierSku String?  // SKU used by supplier
  leadTime   Int?     // Days
  minOrder   Int?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  // Relations
  product  Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  supplier Supplier @relation(fields: [supplierId], references: [id], onDelete: Cascade)

  @@unique([productId, supplierId])
  @@map("product_suppliers")
}

// Stock model - Current inventory levels per warehouse
model Stock {
  id          String   @id @default(cuid())
  productId   String
  warehouseId String
  quantity    Int      @default(0)
  reserved    Int      @default(0) // Reserved for orders
  available   Int      @default(0) // quantity - reserved
  reorderLevel Int     @default(10) // Minimum quantity to reorder
  lastCounted DateTime? // Last physical count
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  product   Product   @relation(fields: [productId], references: [id], onDelete: Cascade)
  warehouse Warehouse @relation(fields: [warehouseId], references: [id], onDelete: Cascade)

  @@unique([productId, warehouseId])
  @@index([warehouseId])
  @@map("stocks")
}

// Stock movement tracking
model StockMovement {
  id          String   @id @default(cuid())
  productId   String
  quantity    Int
  movementType StockMovementType
  reference   String?  // Reference to order, transfer, etc.
  notes       String?
  createdAt   DateTime @default(now())

  // Relations
  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([productId])
  @@index([createdAt])
  @@map("stock_movements")
}

enum StockMovementType {
  INBOUND      // Purchase order received
  OUTBOUND     // Sale or consumption
  ADJUSTMENT   // Inventory adjustment
  RETURN       // Customer return
  TRANSFER     // Between warehouses
  DAMAGE       // Damaged goods
  LOSS         // Loss/theft
}

// Stock transfer between warehouses
model StockTransfer {
  id              String   @id @default(cuid())
  productId       String
  fromWarehouseId String
  toWarehouseId   String
  quantity        Int
  status          TransferStatus @default(PENDING)
  initiatedBy     String
  notes           String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  product       Product   @relation(fields: [productId], references: [id], onDelete: Cascade)
  fromWarehouse Warehouse @relation("FromWarehouse", fields: [fromWarehouseId], references: [id])
  toWarehouse   Warehouse @relation("ToWarehouse", fields: [toWarehouseId], references: [id])
  user          User      @relation(fields: [initiatedBy], references: [id])

  @@index([productId])
  @@index([fromWarehouseId])
  @@index([toWarehouseId])
  @@map("stock_transfers")
}

enum TransferStatus {
  PENDING
  IN_TRANSIT
  COMPLETED
  CANCELLED
}

// Purchase Order model
model PurchaseOrder {
  id          String   @id @default(cuid())
  poNumber    String   @unique
  supplierId  String
  status      POStatus @default(DRAFT)
  expectedDate DateTime?
  receivedDate DateTime?
  notes       String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  supplier Supplier          @relation(fields: [supplierId], references: [id])
  items    PurchaseOrderItem[]

  @@index([supplierId])
  @@map("purchase_orders")
}

enum POStatus {
  DRAFT
  SUBMITTED
  CONFIRMED
  RECEIVED
  COMPLETED
  CANCELLED
}

// Purchase Order Items
model PurchaseOrderItem {
  id              String   @id @default(cuid())
  purchaseOrderId String
  productId       String
  quantity        Int
  unitPrice       Float
  receivedQuantity Int @default(0)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  purchaseOrder PurchaseOrder @relation(fields: [purchaseOrderId], references: [id], onDelete: Cascade)

  @@map("purchase_order_items")
}

// Activity log for audit trail
model Activity {
  id          String   @id @default(cuid())
  userId      String
  action      String
  entityType  String   // Product, Stock, Warehouse, etc.
  entityId    String
  oldValue    String?
  newValue    String?
  details     String?
  createdAt   DateTime @default(now())

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([entityType])
  @@index([createdAt])
  @@map("activities")
}
